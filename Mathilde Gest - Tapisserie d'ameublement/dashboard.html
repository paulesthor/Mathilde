<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin | Mathilde Gest</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/navigation.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .dash-section {
            display: none;
            /* Hidden by default */
            animation: fadeIn 0.3s ease;
        }

        #section-clients {
            display: block;
            /* Default active */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Notification Badge Styles */
        .dash-tab {
            position: relative;
        }

        .notif-dot {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background-color: #c62828;
            /* Red */
            border-radius: 50%;
            display: none;
            /* Hidden by default */
        }
    </style>
</head>

<body>

    <!-- HEADER MOBILE -->
    <div class="mobile-header">
        <a href="index.html" class="mobile-logo">MATHILDE GEST</a>
        <button class="burger-btn" id="burger-toggle">
            <span class="burger-line"></span>
            <span class="burger-line"></span>
            <span class="burger-line"></span>
        </button>
    </div>

    <!-- SIDEBAR NAVIGATION -->
    <aside class="sidebar" id="sidebar">
        <a href="index.html" class="sidebar-logo">
            <div class="logo-text">Mat.<br>Gest</div>
            <span class="logo-sub">Atelier Paris</span>
        </a>

        <nav class="sidebar-nav">
            <ul>
                <li><a href="index.html">Accueil</a></li>
                <li><a href="categories.html">Cr√©ations</a></li>
                <li><a href="dashboard.html" class="active">Dashboard</a></li>
                <li><a href="contact.html">Atelier</a></li>
            </ul>
        </nav>

        <div class="sidebar-footer">
            <p style="font-size: 0.85rem; line-height: 1.6;">12 Rue de la Tapisserie<br>75000 Paris</p>
            <div style="font-size: 0.75rem; margin-top: 1rem;">
                <a href="mentions-legales.html" style="text-decoration: underline;">Mentions L√©gales</a><br>
                <a href="politique-confidentialite.html" style="text-decoration: underline;">Politique de
                    Confidentialit√©</a>
            </div>
            <button id="logout-btn" class="btn btn-outline"
                style="margin-top: 1rem; width: 100%; font-size: 0.8rem; padding: 0.5rem;">D√©connexion</button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content" style="padding: 4rem;">
        <h1 style="margin-bottom: 2rem;">Tableau de Bord Admin</h1>

        <!-- Stats Cards -->
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <h3>Clients Total</h3>
                    <p class="stat-value" id="total-customers">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úâÔ∏è</div>
                <div class="stat-content">
                    <h3>Messages</h3>
                    <p class="stat-value" id="unread-messages">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üìÖ</div>
                <div class="stat-content">
                    <h3>RDV √† venir</h3>
                    <p class="stat-value" id="pending-appointments">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì∑</div>
                <div class="stat-content">
                    <h3>Produits</h3>
                    <p class="stat-value" id="total-products">-</p>
                </div>
            </div>
        </section>

        <!-- DASHBOARD TABS -->
        <div class="dashboard-tabs"
            style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid #eee;">
            <button class="dash-tab active" onclick="switchDashTab('clients')"
                style="padding: 1rem; border: none; background: none; font-weight: 600; cursor: pointer; border-bottom: 2px solid var(--color-primary);">Clients</button>
            <button class="dash-tab" onclick="switchDashTab('messages')"
                style="padding: 1rem; border: none; background: none; color: #999; cursor: pointer;">
                Messagerie
                <span id="badge-messages" class="notif-dot"></span>
            </button>
            <button class="dash-tab" onclick="switchDashTab('appointments')"
                style="padding: 1rem; border: none; background: none; color: #999; cursor: pointer;">
                Agenda
                <span id="badge-appointments" class="notif-dot"></span>
            </button>
            <button class="dash-tab" onclick="switchDashTab('reviews')"
                style="padding: 1rem; border: none; background: none; color: #999; cursor: pointer;">
                Avis Clients
                <span id="badge-reviews" class="notif-dot"></span>
            </button>
        </div>

        <!-- SECTION: CLIENTS -->
        <div id="section-clients" class="dash-section">
            <section class="customer-list-section">
                <div class="section-header">
                    <h2>Liste des Clients</h2>
                    <div class="section-actions">
                        <input type="text" id="search-customers" placeholder="Rechercher..." class="search-input">
                        <button id="export-csv" class="btn">üì• Export CSV</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="customer-table" id="customer-table">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>T√©l√©phone</th>
                                <th>Ville</th>
                                <th>Date Inscription</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">Chargement...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- SECTION: MESSAGES -->
        <div id="section-messages" class="dash-section">
            <div class="section-header">
                <h2>Bo√Æte de R√©ception</h2>
                <button class="btn" onclick="loadMessages()">üîÑ Rafra√Æchir</button>
            </div>
            <div id="messages-list" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Messages will be injected here -->
                <p style="text-align: center; color: #999;">Chargement des messages...</p>
            </div>
        </div>

        <!-- SECTION: APPOINTMENTS -->
        <div id="section-appointments" class="dash-section">
            <div class="section-header">
                <h2>Demandes de Rendez-vous</h2>
                <button class="btn" onclick="loadAppointments()">üîÑ Rafra√Æchir</button>
            </div>
            <div class="table-container">
                <table class="customer-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Date Souhait√©e</th>
                            <th>Motif</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointments-body">
                        <!-- Appointments injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SECTION: REVIEWS -->
        <div id="section-reviews" class="dash-section">
            <div class="section-header">
                <h2>Mod√©ration des Avis</h2>
                <button class="btn" onclick="loadReviews()">üîÑ Rafra√Æchir</button>
            </div>
            <div id="reviews-mod-list" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Reviews injected here -->
            </div>
        </div>

        <!-- Activity Feed (shared/bottom) -->
        <section class="activity-section" style="margin-top: 3rem; border-top: 1px solid #eee; padding-top: 2rem;">
            <h2>Activit√© R√©cente</h2>
            <div id="activity-feed" class="activity-feed">
                <p style="text-align: center; color: #999;">Chargement...</p>
            </div>
        </section>

        <!-- MODALS -->

        <!-- Reply Modal -->
        <div id="reply-modal" class="modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
            <div
                style="background:white; padding:2rem; border-radius:8px; width:90%; max-width:500px; position:relative;">
                <h3 style="margin-bottom:1rem;">R√©pondre au message</h3>
                <form id="reply-form">
                    <input type="hidden" id="reply-parent-id">
                    <input type="hidden" id="reply-recipient">
                    <input type="hidden" id="reply-subject-orig">

                    <div style="margin-bottom:1rem;">
                        <label style="display:block; font-size:0.9rem; margin-bottom:0.5rem;">Message</label>
                        <textarea id="reply-content" rows="5" style="width:100%; padding:0.5rem;" required></textarea>
                    </div>

                    <div style="text-align:right; gap:0.5rem; display:flex; justify-content:flex-end;">
                        <button type="button" onclick="closeModal('reply-modal')" class="btn btn-outline"
                            style="padding:0.5rem 1rem;">Annuler</button>
                        <button type="submit" class="btn btn-primary" style="padding:0.5rem 1rem;">Envoyer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Appointment Modal -->
        <div id="appointment-modal" class="modal"
            style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
            <div
                style="background:white; padding:2rem; border-radius:8px; width:90%; max-width:500px; position:relative;">
                <h3 style="margin-bottom:1rem;">G√©rer le Rendez-vous</h3>
                <form id="appointment-manage-form">
                    <input type="hidden" id="app-id">
                    <input type="hidden" id="app-client-email">

                    <div style="margin-bottom:1rem;">
                        <label style="display:block; font-size:0.9rem; margin-bottom:0.5rem;">Action</label>
                        <select id="app-action" style="width:100%; padding:0.5rem;" onchange="toggleDateInput()">
                            <option value="confirmed">‚úÖ Confirmer le RDV</option>
                            <option value="cancelled">‚ùå Annuler le RDV</option>
                            <option value="proposed">üìÖ Proposer une autre date</option>
                        </select>
                    </div>

                    <div id="date-proposal-group" style="margin-bottom:1rem; display:none;">
                        <label style="display:block; font-size:0.9rem; margin-bottom:0.5rem;">Nouvelle date
                            propos√©e</label>
                        <input type="datetime-local" id="app-new-date" style="width:100%; padding:0.5rem;">
                    </div>

                    <div style="margin-bottom:1rem;">
                        <label style="display:block; font-size:0.9rem; margin-bottom:0.5rem;">Message au client</label>
                        <textarea id="app-message" rows="3" style="width:100%; padding:0.5rem;"
                            placeholder="Raison de l'annulation ou d√©tails suppl√©mentaires..."></textarea>
                    </div>

                    <div style="text-align:right; gap:0.5rem; display:flex; justify-content:flex-end;">
                        <button type="button" onclick="closeModal('appointment-modal')" class="btn btn-outline"
                            style="padding:0.5rem 1rem;">Annuler</button>
                        <button type="submit" class="btn btn-primary" style="padding:0.5rem 1rem;">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- MAIN CONTENT END -->
        <footer style="margin-top: 4rem; text-align: center; color: #999;">
            <p>&copy; 2024 Mathilde Gest.</p>
        </footer>
    </main>

    <!-- JS INTERACTIONS -->
    <script>
        // Toggle Mobile Menu
        const burger = document.getElementById('burger-toggle');
        const sidebar = document.getElementById('sidebar');

        if (burger && sidebar) {
            burger.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });
        }

        // Logout handler
        document.getElementById('logout-btn')?.addEventListener('click', async () => {
            const { supabase } = await import('./js/config.js');
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        });

        // Tab Switching Logic
        function switchDashTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.dash-section').forEach(el => el.style.display = 'none');
            // Show target
            document.getElementById('section-' + tabName).style.display = 'block';

            // Update buttons
            document.querySelectorAll('.dash-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.borderBottom = 'none';
                btn.style.color = '#999';
            });

            // Highlight active button
            const activeBtn = Array.from(document.querySelectorAll('.dash-tab')).find(b => b.textContent.toLowerCase().includes(tabName === 'clients' ? 'clients' : (tabName === 'messages' ? 'messagerie' : (tabName === 'appointments' ? 'agenda' : 'avis'))));
            if (activeBtn) {
                activeBtn.style.borderBottom = '2px solid var(--color-primary)';
                activeBtn.style.color = 'var(--color-primary)';
                activeBtn.classList.add('active');
            }
        }

        // Modal Utilities
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function toggleDateInput() {
            const action = document.getElementById('app-action').value;
            document.getElementById('date-proposal-group').style.display = (action === 'proposed') ? 'block' : 'none';
        }
    </script>

    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/dashboard.js"></script>
</body>

</html>